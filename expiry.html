
{% extends "base.html" %}

{% block title %}Expiry Alerts - Pharmacy Inventory System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Expiry Alerts</h1>
    <div class="btn-group" role="group">
        <a href="?days=7" class="btn btn-{{ 'warning' if days == 7 else 'outline-warning' }}">7 Days</a>
        <a href="?days=30" class="btn btn-{{ 'warning' if days == 30 else 'outline-warning' }}">30 Days</a>
        <a href="?days=90" class="btn btn-{{ 'warning' if days == 90 else 'outline-warning' }}">90 Days</a>
    </div>
</div>

<div class="alert alert-warning">
    <div class="d-flex align-items-center">
        <i class="fas fa-info-circle fa-2x me-3"></i>
        <div>
            <h6 class="mb-1">Expiry Alert System</h6>
            <p class="mb-0">Showing medicines expiring within {{ days }} days. Take action to prevent losses.</p>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Medicines Expiring Within {{ days }} Days</h5>
        <span class="badge bg-warning fs-6">{{ expiring|length }} item(s)</span>
    </div>
    <div class="card-body">
        {% if expiring %}
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th>Medicine Name</th>
                            <th>Current Stock</th>
                            <th>Expiry Date</th>
                            <th>Days Remaining</th>
                            <th>Priority</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in expiring %}
                        {% set days_remaining = item[3] %}
                        {% set priority = 'CRITICAL' if days_remaining <= 7 else 'HIGH' if days_remaining <= 30 else 'MEDIUM' %}
                        <tr class="{{ 'table-danger' if priority == 'CRITICAL' else 'table-warning' if priority == 'HIGH' else 'table-light' }}">
                            <td><strong>{{ item[0] }}</strong></td>
                            <td>
                                <span class="badge bg-{{ 'danger' if item[1] <= 10 else 'primary' }} fs-6">
                                    {{ item[1] }} units
                                </span>
                            </td>
                            <td>{{ item[2] }}</td>
                            <td>
                                {% if days_remaining <= 0 %}
                                    <span class="badge bg-danger">EXPIRED</span>
                                {% else %}
                                    <span class="text-{{ 'danger' if days_remaining <= 7 else 'warning' if days_remaining <= 30 else 'muted' }}">
                                        {{ days_remaining }} day{{ 's' if days_remaining != 1 else '' }}
                                    </span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'danger' if priority == 'CRITICAL' else 'warning' if priority == 'HIGH' else 'secondary' }}">
                                    {{ priority }}
                                </span>
                            </td></td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% if days_remaining > 0 %}
                                        <button class="btn btn-outline-primary" onclick="createDiscount('{{ item[0] }}', {{ item[1] }})">
                                            <i class="fas fa-percentage me-1"></i>Discount
                                        </button>
                                    {% endif %}
                                    {% if days_remaining <= 0 %}
                                        <button class="btn btn-outline-danger" onclick="markExpired('{{ item[0] }}')">
                                            <i class="fas fa-trash me-1"></i>Remove
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Summary Statistics -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <h3 class="text-danger">{{ expiring|selectattr('3')|select('<=', 7)|list|length }}</h3>
                            <p class="mb-0">Critical (≤7 days)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h3 class="text-warning">{{ expiring|length }}</h3>
                            <p class="mb-0">Total Expiring</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h3 class="text-info">{{ expiring|sum(attribute=1) }}</h3>
                            <p class="mb-0">Units at Risk</p>
                        </div>
                    </div>
                </div>
            </div>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    {% if days_remaining > 0 %}
                                        <button class="btn btn-outline-primary" onclick="createDiscount('{{ item[0] }}', {{ item[1] }})">
                                            <i class="fas fa-percentage me-1"></i>Discount
                                        </button>
                                    {% endif %}
                                    {% if days_remaining <= 0 %}
                                        <button class="btn btn-outline-danger" onclick="markExpired('{{ item[0] }}')">
                                            <i class="fas fa-trash me-1"></i>Remove
                                        </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Summary Statistics -->
            <div class="row mt-4">
                <div class="col-md-4">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <h3 class="text-danger">{{ expiring|selectattr('2')|list|length }}</h3>
                            <p class="mb-0">Critical (≤7 days)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <h3 class="text-warning">{{ expiring|length }}</h3>
                            <p class="mb-0">Total Expiring</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card border-info">
                        <div class="card-body text-center">
                            <h3 class="text-info">{{ expiring|sum(attribute=1) }}</h3>
                            <p class="mb-0">Units at Risk</p>
                        </div>
                    </div>
                </div>
            </div>

        {% else %}
            <div class="text-center text-muted py-5">
                <i class="fas fa-check-circle fa-3x mb-3 text-success"></i>
                <h4 class="text-success">All Clear!</h4>
                <p>No medicines are expiring within {{ days }} days.</p>
                <a href="{{ url_for('inventory') }}" class="btn btn-success">
                    <i class="fas fa-boxes me-2"></i>View Inventory
                </a>
            </div>
        {% endif %}
    </div>
</div>

{% if expiring %}
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0"><i class="fas fa-lightbulb me-2 text-warning"></i>Recommended Actions</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6>For Critical Items (≤7 days):</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-percentage text-danger me-2"></i>Offer significant discounts (30-50%)</li>
                    <li><i class="fas fa-gift text-danger me-2"></i>Bundle with other medicines</li>
                    <li><i class="fas fa-users text-danger me-2"></i>Contact regular customers</li>
                    <li><i class="fas fa-hospital text-danger me-2"></i>Donate to charitable organizations</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>For High Priority Items (8-30 days):</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-tags text-warning me-2"></i>Moderate discounts (15-25%)</li>
                    <li><i class="fas fa-bullhorn text-warning me-2"></i>Promote to customers</li>
                    <li><i class="fas fa-chart-line text-warning me-2"></i>Monitor sales closely</li>
                    <li><i class="fas fa-exchange-alt text-warning me-2"></i>Consider supplier return</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
function createDiscount(medicineName, stock) {
    alert(`Create discount strategy for ${medicineName} (${stock} units in stock)`);
    // This could open a modal to create discount policies
}

function markExpired(medicineName) {
    if (confirm(`Mark ${medicineName} as expired and remove from inventory?`)) {
        alert(`${medicineName} marked as expired and removed from inventory`);
        // This would typically send an AJAX request to update the database
        location.reload();
    }
}
</script>
{% endblock %}
